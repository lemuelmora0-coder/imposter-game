<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ST VINCENT: Impostor</title>
    <style>
        :root { --glow: #00d4ff; --bg: #0a0e14; --card: #151d29; --text: #e0e6ed; --danger: #ff4757; --warning: #f1c40f; }
        html, body { height: 100%; margin: 0; overflow: hidden; background: #090A0F; }
        body { font-family: 'Segoe UI', sans-serif; color: var(--text); text-align: center; user-select: none; display: flex; justify-content: center; align-items: center; }
        
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .stars-1 { background: transparent; box-shadow: 444px 111px #FFF, 123px 456px #FFF, 890px 234px #FFF, 500px 700px #FFF, 1500px 300px #FFF; width: 1px; height: 1px; animation: animStar 60s linear infinite; }
        .stars-1:after { content: " "; position: absolute; top: 2000px; width: 1px; height: 1px; box-shadow: inherit; }
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }
        
        .content-wrapper { z-index: 10; position: relative; width: 100%; padding: 20px; }
        .card { background: rgba(21, 29, 41, 0.9); backdrop-filter: blur(15px); padding: 30px; border-radius: 20px; border: 1px solid #30363d; display: inline-block; width: 90%; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.9); }
        
        h2 { color: var(--glow); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--glow); font-size: 1.2rem; }
        input, select { background: rgba(13, 17, 23, 0.9); border: 1px solid #30363d; color: var(--glow); padding: 12px; border-radius: 8px; width: 85%; margin: 8px 0; font-size: 0.95rem; outline: none; }
        
        button { background: var(--glow); color: #000; font-weight: bold; border: none; padding: 16px; border-radius: 12px; cursor: pointer; width: 100%; margin-top: 15px; text-transform: uppercase; transition: 0.3s; }
        button:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--glow); }
        
        .word-box { font-size: 2.2rem; font-weight: 900; margin: 25px 0; min-height: 60px; color: var(--danger); text-shadow: 0 0 15px var(--danger); }
        .hold-btn { background: rgba(48, 54, 61, 0.7); color: white; padding: 30px; border: 2px dashed var(--glow); border-radius: 15px; cursor: pointer; touch-action: manipulation; font-weight: bold; }
        .hold-btn:active { background: var(--glow); color: black; box-shadow: 0 0 30px var(--glow); border-style: solid; }
        
        .warning-text { color: var(--warning); font-weight: bold; text-transform: uppercase; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .hidden { display: none !important; }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #090A0F; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Custom message box to replace alert */
        #msg-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 10px 20px; border-radius: 10px; z-index: 200; display: none; }
    </style>
</head>
<body>

    <div id="msg-box"></div>

    <div id="splash-screen">
        <h1 style="color: var(--glow); text-shadow: 0 0 15px var(--glow);">ST VINCENT PROTOCOL</h1>
        <button onclick="initApp()" style="width: 200px;">ENTER SYSTEM</button>
    </div>

    <div class="stars stars-1"></div>

    <div class="content-wrapper">
        <div id="setup-screen" class="card hidden">
            <h2>ST VINCENT, WHO'S THE IMPOSTOR</h2>
            <select id="saved-decks-dropdown" onchange="loadDeck()">
                <option value="">-- Load Saved Deck --</option>
            </select>
            <input type="text" id="deck-name" placeholder="Deck Name">
            <input type="text" id="custom-words" placeholder="Words (e.g. Word1, Word2)">
            <input type="number" id="player-count" placeholder="Total Players" min="3" value="3">
            <input type="number" id="impostor-count" placeholder="Number of Impostors" min="1" value="1">
            <button onclick="startGame()">INITIALIZE LINK</button>
        </div>

        <div id="game-screen" class="card hidden">
            <h3 id="player-turn-text">UNIT 1 READY</h3>
            <div id="word-display" class="word-box">****</div>
            <div id="hold-trigger" class="hold-btn">HOLD TO DECRYPT</div>
            <button id="next-btn" class="hidden" onclick="nextPlayer()">DONE & PASS</button>
        </div>

        <div id="warning-screen" class="card hidden">
            <h2 class="warning-text">PROTOCOL COMPLETE</h2>
            <p>ALL UNITS HAVE BEEN BRIEFED.</p>
            <button onclick="finalReveal()" style="background: var(--danger); color: white;">FINAL REVEAL</button>
        </div>

        <div id="reveal-screen" class="card hidden">
            <h2 style="color: var(--danger);">/// ANOMALIES DETECTED ///</h2>
            <div id="impostor-reveal" class="word-box" style="color: var(--glow); font-size: 1.5rem;">?</div>
            <button onclick="location.reload()">REBOOT SYSTEM</button>
        </div>
    </div>

    <audio id="snd-bgm" src="lofibg.mp3" loop></audio>

    <script>
        // Global state
        let players = [];
        let currentPlayerIndex = 0;
        let impostors = [];
        let allDecks = {}; // Only declared ONCE here

        const preinstalledDecks = {
             "ST Vincent": "Sean, Bella, Jed, Mico, Juliana, Deneach, Kian, Kate, Rainiel, Ashley (Bolonias), Ashley (Ebuen), Kevin, Andrea, Lyan, Lem, Kristine, Eze, Alyssa, Deanna, Jj, Ken, Mhon, Anica, Vanessa, Queen, Dianne, Liam, Janessa, Louise, Jumarc, Trixine, Shelly, Loraine, Bj, Zairus, Lara, Shaq, Michael, Ryan, Casey, Rhian, Jannah, Aj, Diane, Matthew, Pj, Aaron, Yanzley, alliyah, chloe, Kurt, Jane, Maam Dionisio, Maam Greysi, Maam Airene, Sir Lance, Maam Casaclang, Maam Rose, Sir GHEL THE GOAT, Sir Jerome",
            "Daily Things": "Toothbrush, Toothpaste, Soap, Shampoo, Towel, Mirror, Comb, Hair Dryer, Bed, Pillow, Blanket, Curtains, Electric Fan, Aircon, Television, Remote Control, Smartphone, Charger, Powerbank, Earphones, Laptop, Mouse, Keyboard, Desk, Chair, Backpack, Wallet, Keys, Shoes, Slippers, Umbrella, Water Bottle, Mug, Plate, Spoon, Fork, Knife, Frying Pan, Stove, Refrigerator, Microwave, Toaster, Coffee Maker, Rice Cooker, Washing Machine, Hanger, Laundry Basket, Iron, Ironing Board, Vacuum Cleaner, Broom, Dustpan, Mop, Trash Can, Clock, Calendar, Notebook, Pen, Pencil, Eraser, Scissors, Tape, Glue, Calculator, Stapler, Paper, Envelope, Stamps, Books, Glasses, Watch, Ring, Necklace, Earrings, Bracelet, Hat, Jacket, T-shirt, Pants, Socks, Underwear, Belt, Perfume, Deodorant, Lotion, Sunscreen, Alcohol, Face Mask, Vitamins, Medicine, Band-aid, First Aid Kit, Flashlight, Battery, Toolkit, Screwdriver, Hammer, Nails, Ladder."
        };

        function showMsg(text) {
            const box = document.getElementById('msg-box');
            box.innerText = text;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        function initApp() {
            document.getElementById('splash-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            const bgm = document.getElementById('snd-bgm');
            bgm.volume = 0.3;
            bgm.play().catch(e => console.log("Audio Blocked", e));
        }

        window.onload = async () => {
            let localDecks = JSON.parse(localStorage.getItem('impostee_decks')) || {};
            let fetchedDecks = {};

            try {
                const response = await fetch('decks.json');
                if (response.ok) {
                    fetchedDecks = await response.json();
                    console.log("Remote decks loaded.");
                }
            } catch (e) {
                console.warn("Could not load decks.json, using local/hardcoded defaults.");
            }

            // Combine everything: Remote > Hardcoded > Local
            allDecks = { ...preinstalledDecks, ...fetchedDecks, ...localDecks };

            const dropdown = document.getElementById('saved-decks-dropdown');
            for (let name in allDecks) {
                dropdown.add(new Option(name, name));
            }
        };

        function loadDeck() {
            const name = document.getElementById('saved-decks-dropdown').value;
            if (allDecks[name]) {
                document.getElementById('deck-name').value = name;
                document.getElementById('custom-words').value = Array.isArray(allDecks[name]) ? allDecks[name].join(", ") : allDecks[name];
            }
        }

        function startGame() {
            const name = document.getElementById('deck-name').value;
            const wordsInput = document.getElementById('custom-words').value;
            const pCount = parseInt(document.getElementById('player-count').value);
            const iCount = parseInt(document.getElementById('impostor-count').value);

            if (!name || !wordsInput || isNaN(pCount)) return showMsg("Data incomplete!");
            if (iCount >= pCount - 1) return showMsg("Too many impostors!");

            // Save custom decks
            if (!preinstalledDecks[name]) {
                let currentLocal = JSON.parse(localStorage.getItem('impostee_decks')) || {};
                currentLocal[name] = wordsInput;
                localStorage.setItem('impostee_decks', JSON.stringify(currentLocal));
            }

            const wordList = wordsInput.split(',').map(w => w.trim()).filter(w => w.length > 0);
            const secret = wordList[Math.floor(Math.random() * wordList.length)];
            
            let indices = Array.from({length: pCount}, (_, i) => i);
            impostors = [];
            for(let i=0; i<iCount; i++) {
                let randomIdx = Math.floor(Math.random() * indices.length);
                impostors.push(indices.splice(randomIdx, 1)[0] + 1);
            }

            players = Array.from({length: pCount}, (_, i) => 
                impostors.includes(i + 1) ? "IMPOSTOR" : secret
            );

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            updateUI();
        }

        function updateUI() {
            document.getElementById('player-turn-text').innerText = `UNIT ${currentPlayerIndex + 1} READY`;
            document.getElementById('word-display').innerText = "****";
            document.getElementById('word-display').style.color = "var(--danger)";
            document.getElementById('hold-trigger').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
        }

        const trigger = document.getElementById('hold-trigger');
        const display = document.getElementById('word-display');

        function show() {
            display.innerText = players[currentPlayerIndex];
            display.style.color = players[currentPlayerIndex] === "IMPOSTOR" ? "var(--danger)" : "var(--glow)";
        }
        function hide() {
            display.innerText = "****";
            display.style.color = "var(--danger)";
            trigger.classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        trigger.addEventListener('mousedown', show);
        trigger.addEventListener('touchstart', (e) => { e.preventDefault(); show(); });
        trigger.addEventListener('mouseup', hide);
        trigger.addEventListener('touchend', hide);

        function nextPlayer() {
            currentPlayerIndex++;
            if (currentPlayerIndex < players.length) {
                updateUI();
            } else {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('warning-screen').classList.remove('hidden');
            }
        }

        function finalReveal() {
            document.getElementById('warning-screen').classList.add('hidden');
            document.getElementById('reveal-screen').classList.remove('hidden');
            document.getElementById('impostor-reveal').innerText = "Units: " + impostors.join(", ");
        }
    </script>
</body>
</html>

